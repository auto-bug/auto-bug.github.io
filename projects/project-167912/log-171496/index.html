
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Firmware - deshipu.art</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
  
     
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="icon" type="image/png" href="../../../_static/favicon.png">

  
  <link rel="alternate" type="application/atom+xml"  href="../../../blog/atom.xml" title="deshipu.art">
  

  </head><body>
<div id="topbar">
<div id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="search" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
    <div id="logo"><a href="../../../">
        <img
            src="/_static/logo.png"
            alt=""
        />deshipu.art</a></div>
</div>

<div role="main">
  <section id="firmware">
<h1>Firmware<a class="headerlink" href="#firmware" title="Permalink to this heading">¶</a></h1>
<p>Published on 2019-12-03 in <a class="reference internal" href="../#project-167912"><span class="std std-ref">Flounder Keyboard</span></a>.</p>
<p>In its simplest form, keyboard firmware is not rocket science. You
basically need to do three things: scan the key matrix to see which
keys are pressed, translate the matrix locations into key codes and
modifiers, and send USB HID reports with lists of currently pressed
keys. Easy.</p>
<p>So why is the KMK firmware so large? Well, it’s written using an
“enterprise” approach — everything is a class that has a hierarchy at
least four levels deep, with abstract interfaces, pre- and post-event
hooks, handlers, validators, layers of abstraction, flexibility and
extensibility. Also RGB LEDs and Unicode emoji. Unfortunately,
removing all the things I didn’t need would require quite a bit of
work, as despite having so many layers of abstraction, the code is
actually pretty tangled. So instead I decided to just write the most
naive code I could, and see if that works. I came up with this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">board</span>
<span class="kn">import</span> <span class="nn">digitalio</span>
<span class="kn">import</span> <span class="nn">usb_hid</span>


<span class="n">COLS</span> <span class="o">=</span> <span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">_C1</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C2</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C3</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C4</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C5</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C6</span><span class="p">,</span>
    <span class="n">board</span><span class="o">.</span><span class="n">_C7</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C8</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C9</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C10</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C11</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C12</span><span class="p">,</span>
    <span class="n">board</span><span class="o">.</span><span class="n">_C14</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C13</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_C15</span><span class="p">)</span>
<span class="n">ROWS</span> <span class="o">=</span> <span class="p">(</span><span class="n">board</span><span class="o">.</span><span class="n">_R1</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_R2</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_R3</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_R4</span><span class="p">,</span> <span class="n">board</span><span class="o">.</span><span class="n">_R5</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">matrix</span><span class="p">):</span>
    <span class="n">report</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">report_mod_keys</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">report</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">report_no_mod_keys</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">report</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">usb_hid</span><span class="o">.</span><span class="n">devices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">usage</span> <span class="o">==</span> <span class="mh">0x06</span> <span class="ow">and</span> <span class="n">device</span><span class="o">.</span><span class="n">usage_page</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;no HID keyboard device&quot;</span><span class="p">)</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">digitalio</span><span class="o">.</span><span class="n">DigitalInOut</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span> <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">digitalio</span><span class="o">.</span><span class="n">DigitalInOut</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span> <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">col</span><span class="o">.</span><span class="n">switch_to_output</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">row</span><span class="o">.</span><span class="n">switch_to_input</span><span class="p">(</span><span class="n">pull</span><span class="o">=</span><span class="n">digitalio</span><span class="o">.</span><span class="n">Pull</span><span class="o">.</span><span class="n">DOWN</span><span class="p">)</span>
    <span class="n">last_state</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="n">col</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
                <span class="n">bit</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">y</span>
                <span class="n">bits</span> <span class="o">|=</span> <span class="n">bit</span>
                <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">last_state</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">y</span><span class="p">)):</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">135</span><span class="p">:</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">code</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">:</span>
                        <span class="n">modifier</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">code</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                            <span class="n">report_mod_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">modifier</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">report_mod_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">modifier</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">report_no_mod_keys</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">:</span>
                                    <span class="n">report_no_mod_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
                                    <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">report_no_mod_keys</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">],</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]):</span>
                                    <span class="n">report_no_mod_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span>
            <span class="n">col</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">last_state</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits</span>
        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">device</span><span class="o">.</span><span class="n">send_report</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

</pre></div>
</div>
<p>Of course you need a <a class="reference external" href="http://main.py">main.py</a>  file to run this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">flounder</span>


<span class="n">MATRIX</span> <span class="o">=</span> <span class="p">(</span>
 <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x1e\x1f</span><span class="s1"> !&quot;#$%&amp;</span><span class="se">\&#39;</span><span class="s1">-.</span><span class="se">\x00</span><span class="s1">*I&#39;</span><span class="p">,</span>
  <span class="sa">b</span><span class="s1">&#39;+</span><span class="se">\x14\x1a\x08\x15\x17\x1c\x18\x0c\x12\x13</span><span class="s1">/01L&#39;</span><span class="p">,</span>
  <span class="sa">b</span><span class="s1">&#39;5</span><span class="se">\x04\x16\x07\t\n\x0b\r\x0e\x0f</span><span class="s1">34</span><span class="se">\x00</span><span class="s1">(K&#39;</span><span class="p">,</span>
  <span class="sa">b</span><span class="s1">&#39;)</span><span class="se">\x81\x1d\x1b\x06\x19\x05\x11\x10</span><span class="s1">678</span><span class="se">\x85</span><span class="s1">RN&#39;</span><span class="p">,</span>
  <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x80</span><span class="s1">9</span><span class="se">\x83\x82\x00</span><span class="s1">,</span><span class="se">\x00\x00\x00\x86\x87\x84</span><span class="s1">PQO&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;:;&lt;=&gt;?@ABCDE</span><span class="se">\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">,</span>
  <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">,</span>
  <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span class="s1">&#39;</span><span class="p">,</span>
  <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x81\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x85</span><span class="s1">K</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span>
  <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x80\x00\x83\x82\x00\x00\x00\x00\x00\x86\x87\x84</span><span class="s1">JNM&#39;</span><span class="p">)</span>
<span class="p">)</span>


<span class="n">flounder</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">flounder</span><span class="o">.</span><span class="n">COLS</span><span class="p">,</span> <span class="n">flounder</span><span class="o">.</span><span class="n">ROWS</span><span class="p">,</span> <span class="n">MATRIX</span><span class="p">)</span>
</pre></div>
</div>
<p>Yes, it’s not very human-readable. The MATRIX actually defines the
codes of all the keys in two layers. Of course I didn’t write it like
that. I generated it with this code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">micropython</span> <span class="kn">import</span> <span class="n">const</span>
<span class="kn">import</span> <span class="nn">pprint</span>

<span class="n">_A</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">_B</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">_C</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">_D</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">_E</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">_F</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="n">_G</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">_H</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="n">_I</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">_J</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="n">_K</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
<span class="n">_L</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">_M</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="n">_N</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
<span class="n">_O</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
<span class="n">_P</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
<span class="n">_Q</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">_R</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
<span class="n">_S</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
<span class="n">_T</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>
<span class="n">_U</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<span class="n">_V</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
<span class="n">_W</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span>
<span class="n">_X</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span>
<span class="n">_Y</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
<span class="n">_Z</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">29</span><span class="p">)</span>

<span class="n">_1</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="n">_2</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span>
<span class="n">_3</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">_4</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>
<span class="n">_5</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">34</span><span class="p">)</span>
<span class="n">_6</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
<span class="n">_7</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>
<span class="n">_8</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">37</span><span class="p">)</span>
<span class="n">_9</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">38</span><span class="p">)</span>
<span class="n">_0</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span>

<span class="n">_ENT</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="c1"># Enter</span>
<span class="n">_ESC</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span> <span class="c1"># Esc</span>
<span class="n">_BS</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># Backspace</span>
<span class="n">_TAB</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">43</span><span class="p">)</span> <span class="c1"># Tab</span>
<span class="n">_SPC</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span> <span class="c1"># Space</span>
<span class="n">_MN</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="c1"># Minus -/_</span>
<span class="n">_EQ</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">46</span><span class="p">)</span> <span class="c1"># Equal =/+</span>
<span class="n">_LB</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">47</span><span class="p">)</span> <span class="c1"># Left bracket [/{</span>
<span class="n">_RB</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">48</span><span class="p">)</span> <span class="c1"># Right bracket ]/}</span>
<span class="n">_BSL</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">49</span><span class="p">)</span> <span class="c1"># Backslash \/|</span>
<span class="n">_SC</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">51</span><span class="p">)</span> <span class="c1"># Semicolon ;/:</span>
<span class="n">_QT</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">52</span><span class="p">)</span> <span class="c1"># Quote &#39;/&quot;</span>
<span class="n">_GR</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">53</span><span class="p">)</span> <span class="c1"># Grave `/~</span>
<span class="n">_CM</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">54</span><span class="p">)</span> <span class="c1"># Comman ,/&lt;</span>
<span class="n">_DT</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">55</span><span class="p">)</span> <span class="c1"># Dot ./&gt;</span>
<span class="n">_SL</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">56</span><span class="p">)</span> <span class="c1"># Slash //?</span>
<span class="n">_CAPS</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">57</span><span class="p">)</span> <span class="c1"># Caps lock</span>

<span class="n">_F1</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">58</span><span class="p">)</span>
<span class="n">_F2</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">59</span><span class="p">)</span>
<span class="n">_F3</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
<span class="n">_F4</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">61</span><span class="p">)</span>
<span class="n">_F5</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">62</span><span class="p">)</span>
<span class="n">_F6</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>
<span class="n">_F7</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">_F8</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">65</span><span class="p">)</span>
<span class="n">_F9</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">66</span><span class="p">)</span>
<span class="n">_F10</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">67</span><span class="p">)</span>
<span class="n">_F11</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">68</span><span class="p">)</span>
<span class="n">_F12</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">69</span><span class="p">)</span>

<span class="n">_PS</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">70</span><span class="p">)</span> <span class="c1"># Print screen</span>
<span class="n">_SCL</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">71</span><span class="p">)</span> <span class="c1"># Scroll lock</span>
<span class="n">_PA</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">72</span><span class="p">)</span> <span class="c1"># Pause</span>

<span class="n">_INS</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">73</span><span class="p">)</span> <span class="c1"># Insert</span>
<span class="n">_HOME</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">74</span><span class="p">)</span> <span class="c1"># Home</span>
<span class="n">_PGUP</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">75</span><span class="p">)</span> <span class="c1"># Page up</span>
<span class="n">_DEL</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">76</span><span class="p">)</span> <span class="c1"># Delete</span>
<span class="n">_END</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">77</span><span class="p">)</span> <span class="c1"># End</span>
<span class="n">_PGDN</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">78</span><span class="p">)</span> <span class="c1"># Page down</span>
<span class="n">_AR</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">79</span><span class="p">)</span> <span class="c1"># Arrow right</span>
<span class="n">_AL</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="c1"># Arrow left</span>
<span class="n">_AD</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">81</span><span class="p">)</span> <span class="c1"># Arrow down</span>
<span class="n">_AU</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">82</span><span class="p">)</span> <span class="c1"># Arrow up</span>

<span class="n">_LCT</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="c1"># Left control</span>
<span class="n">_LSH</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">129</span><span class="p">)</span> <span class="c1"># Left shift</span>
<span class="n">_LAL</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">130</span><span class="p">)</span> <span class="c1"># Left alternate</span>
<span class="n">_LSP</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span> <span class="c1"># Left super</span>
<span class="n">_RCT</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span> <span class="c1"># Right control</span>
<span class="n">_RSH</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span> <span class="c1"># Right shift</span>
<span class="n">_RAL</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">134</span><span class="p">)</span> <span class="c1"># Right alternate</span>
<span class="n">_FN</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">135</span><span class="p">)</span> <span class="c1"># Function</span>

<span class="n">MATRIX</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">,</span> <span class="n">_4</span><span class="p">,</span> <span class="n">_5</span><span class="p">,</span> <span class="n">_6</span><span class="p">,</span> <span class="n">_7</span><span class="p">,</span> <span class="n">_8</span><span class="p">,</span> <span class="n">_9</span><span class="p">,</span> <span class="n">_0</span><span class="p">,</span> <span class="n">_MN</span><span class="p">,</span> <span class="n">_EQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_BS</span><span class="p">,</span> <span class="n">_INS</span><span class="p">),</span>
    <span class="p">(</span><span class="n">_TAB</span><span class="p">,</span> <span class="n">_Q</span><span class="p">,</span> <span class="n">_W</span><span class="p">,</span> <span class="n">_E</span><span class="p">,</span> <span class="n">_R</span><span class="p">,</span> <span class="n">_T</span><span class="p">,</span> <span class="n">_Y</span><span class="p">,</span> <span class="n">_U</span><span class="p">,</span> <span class="n">_I</span><span class="p">,</span> <span class="n">_O</span><span class="p">,</span> <span class="n">_P</span><span class="p">,</span> <span class="n">_LB</span><span class="p">,</span> <span class="n">_RB</span><span class="p">,</span> <span class="n">_BSL</span><span class="p">,</span> <span class="n">_DEL</span><span class="p">),</span>
    <span class="p">(</span><span class="n">_GR</span><span class="p">,</span> <span class="n">_A</span><span class="p">,</span> <span class="n">_S</span><span class="p">,</span> <span class="n">_D</span><span class="p">,</span> <span class="n">_F</span><span class="p">,</span> <span class="n">_G</span><span class="p">,</span> <span class="n">_H</span><span class="p">,</span> <span class="n">_J</span><span class="p">,</span> <span class="n">_K</span><span class="p">,</span> <span class="n">_L</span><span class="p">,</span> <span class="n">_SC</span><span class="p">,</span> <span class="n">_QT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_ENT</span><span class="p">,</span> <span class="n">_PGUP</span><span class="p">),</span>
    <span class="p">(</span><span class="n">_ESC</span><span class="p">,</span> <span class="n">_LSH</span><span class="p">,</span> <span class="n">_Z</span><span class="p">,</span> <span class="n">_X</span><span class="p">,</span> <span class="n">_C</span><span class="p">,</span> <span class="n">_V</span><span class="p">,</span> <span class="n">_B</span><span class="p">,</span> <span class="n">_N</span><span class="p">,</span> <span class="n">_M</span><span class="p">,</span> <span class="n">_CM</span><span class="p">,</span> <span class="n">_DT</span><span class="p">,</span> <span class="n">_SL</span><span class="p">,</span> <span class="n">_RSH</span><span class="p">,</span> <span class="n">_AU</span><span class="p">,</span> <span class="n">_PGDN</span><span class="p">),</span>
    <span class="p">(</span><span class="n">_LCT</span><span class="p">,</span> <span class="n">_CAPS</span><span class="p">,</span> <span class="n">_LSP</span><span class="p">,</span> <span class="n">_LAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_SPC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_RAL</span><span class="p">,</span> <span class="n">_FN</span><span class="p">,</span> <span class="n">_RCT</span><span class="p">,</span> <span class="n">_AL</span><span class="p">,</span> <span class="n">_AD</span><span class="p">,</span> <span class="n">_AR</span><span class="p">),</span>
<span class="p">),</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">_F1</span><span class="p">,</span> <span class="n">_F2</span><span class="p">,</span> <span class="n">_F3</span><span class="p">,</span> <span class="n">_F4</span><span class="p">,</span> <span class="n">_F5</span><span class="p">,</span> <span class="n">_F6</span><span class="p">,</span> <span class="n">_F7</span><span class="p">,</span> <span class="n">_F8</span><span class="p">,</span> <span class="n">_F9</span><span class="p">,</span> <span class="n">_F10</span><span class="p">,</span> <span class="n">_F11</span><span class="p">,</span> <span class="n">_F12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_LSH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_RSH</span><span class="p">,</span> <span class="n">_PGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">(</span><span class="n">_LCT</span><span class="p">,</span> <span class="n">_CAPS</span><span class="p">,</span> <span class="n">_LSP</span><span class="p">,</span> <span class="n">_LAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_RAL</span><span class="p">,</span> <span class="n">_FN</span><span class="p">,</span> <span class="n">_RCT</span><span class="p">,</span> <span class="n">_HOME</span><span class="p">,</span> <span class="n">_PGDN</span><span class="p">,</span> <span class="n">_END</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">matrix</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">MATRIX</span><span class="p">)</span>
<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

</pre></div>
</div>
<p>Actually initially I used that code directly, but then I decided to
try and save a little bit more flash space (the code above takes
almost no RAM, as it’s all constants that are replaced in place with
number literals).</p>
<p>In any case, despite a few quirks (the modifier keys have to be
present in both layers in the same places, for example) and a complete
lack of software debouncing, it seems to work well.</p>
<p>As a final touch, I compiled a version of CircuitPython with all but
HID USB devices disabled, so that it’s only visible as a keyboard, and
not a million other devices.</p>
</section>


</div>
  </body>
</html>